<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KavyaShift â€” Tracking Your Shift</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
* { box-sizing: border-box; }
body { margin: 0; font-family: "Inter", sans-serif; background: linear-gradient(to bottom, #f8faff, #d7dfef); height: 100vh; overflow-x: hidden; }
.navbar { position: fixed; top: 0; left: 0; width: 100%; z-index: 10; background: white; padding: 18px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
.nav-left img { height: 52px; }
.nav-right { display: flex; align-items: center; gap: 22px; }
.clock { font-size: 14px; display: flex; align-items: center; gap: 6px; }
.avatar { width: 36px; height: 36px; border-radius: 50%; background: #1e74ff; color: #fff; display:flex; align-items:center; justify-content:center; font-weight:600; }
.logout-btn { background: #eef2ff; border: 1px solid #c9d3ff; padding: 7px 20px; border-radius: 40px; cursor: pointer; }
/* Tracking content */
.content { margin-top: 110px; display: flex; justify-content: center; }
.main-wrapper { width: 1200px; position: relative; }
#trackingView, #summaryView { position: absolute; width: 100%; }
#summaryView { display:none; }
/* layout & cards */
.layout { display: grid; grid-template-columns: 300px auto; gap: 80px; }
.left-card, .info-card, .pastel-card, .summary-big-card { border-radius: 12px; padding: 16px; margin-bottom: 20px; background: white; box-shadow:0 4px 12px rgba(0,0,0,0.1); border:1px solid #ddd; }
.left-card-title { font-size: 14px; color: #777; margin-bottom: 6px; display: flex; gap: 6px; }
.green-dot { width: 10px; height: 10px; border-radius: 50%; background:#2ecc71; }
.left-card-value { font-size: 22px; font-weight: 600; }
.center-box { text-align:center; transform: translateY(-95px); }
.circle { width: 240px; height: 240px; border-radius: 50%; border: 10px solid #4ea4ff; background:#e7eeff; margin:auto; display:flex; justify-content:center; align-items:center; box-shadow:0 8px 20px rgba(0,0,0,0.12); }
.circle h2 { font-size:32px; margin:0; }
.circle p { margin:0; color:#777; }
.info-grid { margin-top:20px; display:grid; grid-template-columns: repeat(2,260px); gap:20px; justify-content:center; }
.info-title{ color:#777; }
.info-value{ font-size:18px; font-weight:700; }
.end-btn { margin-top: 20px; padding: 12px 34px; background: #ff5757; color: white; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; }
/* summary page */
.summary-layout { display:grid; grid-template-columns: 300px auto; gap:80px; margin-top:20px; }
.pastel-login{ background:#e8f1ff; }
.pastel-logout{ background:#f7e9ff; }
.pastel-total{ background:#e6ffe9; }
.pastel-title{ color:#555; margin-bottom:6px; }
.pastel-value{ font-size:18px; font-weight:600; }
.summary-circle{ width:220px; height:220px; border-radius:50%; background:#1fbb4c; margin:auto; margin-bottom:20px; display:flex; justify-content:center; align-items:center; box-shadow:0 8px 20px rgba(0,0,0,0.2); }
.tick-inner{ width:120px; height:120px; border-radius:50%; border:10px solid #fff; font-size:55px; color:#fff; display:flex; justify-content:center; align-items:center; }
.summary-big-card{ width: 760px; background:white; border-radius:12px; border:1px solid #ddd; padding:28px 42px; margin:auto; margin-top:20px; box-shadow:0 4px 14px rgba(0,0,0,0.12); display:grid; grid-template-columns:1fr 1fr; row-gap:22px; column-gap:40px; }
.summary-label{ font-size:13px; font-weight:500; color:#555; }
.summary-text{ font-size:17px; font-weight:600; }
.confirm-wrap{ grid-column:1 / 3; display:flex; justify-content:right; margin-top:8px; }
.confirm-btn{ padding:10px 32px; background:#2262ff; color:white; border:none; border-radius:8px; cursor:pointer; font-size:14px; box-shadow:0 3px 6px rgba(0,0,0,0.15); }
.confirm-btn:hover{ background:#0049ff; }
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
    <div class="nav-left">
        <img src="https://i.imgur.com/5tXckwP.png">
    </div>

    <div class="nav-right">
        <div class="clock" id="clock">ðŸ•’ 00:00</div>
        <div class="avatar" id="avatar">U</div>
        <div>
            <div id="userName">User</div>
            <span style="font-size:12px;color:#666;" id="userDevice">Office Desktop</span>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="content">
    <div class="main-wrapper">

        <!-- TRACKING -->
        <div id="trackingView">
            <h1>Tracking Your Shift</h1>
            <h3 id="trackingName">User</h3>

            <div class="layout">
                <div>
                    <div class="left-card">
                        <div class="left-card-title"><span class="green-dot"></span> Status</div>
                        <div class="left-card-value" id="status">Offline</div>
                    </div>
                    <div class="left-card">
                        <div class="left-card-title">Active Shift</div>
                        <div class="left-card-value" id="activeShift">00:00:00</div>
                    </div>
                    <div class="left-card">
                        <div class="left-card-title">Idle Time</div>
                        <div class="left-card-value" id="idleTime">00:00:00</div>
                    </div>
                </div>

                <div class="center-box">
                    <div class="circle">
                        <div>
                            <h2 id="mainTimer">00:00:00</h2>
                            <p>Active Session</p>
                        </div>
                    </div>

                    <div class="info-grid">
                        <div class="info-card"><div class="info-title">Login Time</div><div class="info-value" id="loginTime">--:--</div></div>
                        <div class="info-card"><div class="info-title">Expected End Time</div><div class="info-value" id="expectedEndTime">--:--</div></div>
                        <div class="info-card"><div class="info-title">Position</div><div class="info-value" id="position">Office Desktop</div></div>
                        <div class="info-card"><div class="info-title">Location</div><div class="info-value" id="location">Head Office</div></div>
                    </div>

                    <button class="end-btn" onclick="endShift()">End Shift</button>
                </div>
            </div>
        </div>

        <!-- SUMMARY -->
        <div id="summaryView">
            <h1>Shift Summary</h1>
            <h3 id="summaryName">User</h3>

            <div class="summary-layout">

                <!-- LEFT -->
                <div>
                    <div class="pastel-card pastel-login">
                        <div class="pastel-title">Login Time</div>
                        <div class="pastel-value" id="summaryLoginTime">--:--</div>
                    </div>
                    <div class="pastel-card pastel-logout">
                        <div class="pastel-title">Logout Time</div>
                        <div class="pastel-value" id="summaryLogoutTime">--:--</div>
                    </div>
                    <div class="pastel-card pastel-total">
                        <div class="pastel-title">Total Duration</div>
                        <div class="pastel-value" id="summaryTotalDuration">0h 0m</div>
                    </div>
                </div>

                <!-- RIGHT -->
                <div>
                    <div class="summary-circle">
                        <div class="tick-inner">âœ”</div>
                    </div>

                    <p style="text-align:center;font-weight:600;margin-top:8px;">Shift Complete!</p>
                    <p style="text-align:center;color:#666;margin-top:-6px;">Hereâ€™s your session summary</p>

                    <div class="summary-big-card">
                        <div>
                            <div class="summary-label">Employee</div>
                            <div class="summary-text" id="summaryEmployee">User</div>
                        </div>

                        <div>
                            <div class="summary-label">Position</div>
                            <div class="summary-text" id="summaryPosition">Office Desktop</div>
                        </div>

                        <div>
                            <div class="summary-label">Location</div>
                            <div class="summary-text" id="summaryLocation">Head Office</div>
                        </div>

                        <div class="confirm-wrap">
                            <button class="confirm-btn" onclick="confirmExit()">Confirm & Exit</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<script>
// -------------------- CONFIG --------------------
const API_BASE = "http://localhost:8080/api";
let sessionId = null;
let loginTime = null;
let seconds = 0;
let timerInterval = null;

// -------------------- DYNAMIC USER INFO --------------------
const userName = localStorage.getItem("fullName") || "User";
const userRole = localStorage.getItem("role") || "EMPLOYEE";
const userDevice = "Office Desktop";

document.getElementById("userName").innerText = userName;
document.getElementById("trackingName").innerText = userName;
document.getElementById("summaryName").innerText = userName;
document.getElementById("summaryEmployee").innerText = userName;
document.getElementById("userDevice").innerText = userDevice;
document.getElementById("position").innerText = userDevice;

// -------------------- CLOCK --------------------
function updateClock(){
    const now = new Date();
    document.getElementById("clock").innerText = "ðŸ•’ " + now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}
setInterval(updateClock, 1000);
updateClock();

// -------------------- TIMER --------------------
function startTimer(startSeconds){
    seconds = startSeconds;
    timerInterval = setInterval(() => {
        seconds++;
        const h = String(Math.floor(seconds/3600)).padStart(2,'0');
        const m = String(Math.floor((seconds%3600)/60)).padStart(2,'0');
        const s = String(seconds%60).padStart(2,'0');

        document.getElementById("mainTimer").innerText = `${h}:${m}:${s}`;
        document.getElementById("activeShift").innerText = `${h}:${m}:${s}`;
    },1000);
}

// -------------------- FETCH SESSION --------------------
async function fetchCurrentSession(){
    try{
        const res = await fetch(`${API_BASE}/sessions/active/email/${encodeURIComponent(userName)}`, {
            headers: {
                "Content-Type":"application/json",
                "Authorization":"Bearer " + localStorage.getItem("token")
            }
        });

        if(res.ok){
            const data = await res.json();
            sessionId = data.sessionId;
            loginTime = new Date(data.loginTime);
            document.getElementById("loginTime").innerText = new Date(loginTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
            const startSeconds = Math.floor((new Date() - loginTime)/1000);
            startTimer(startSeconds);
            document.getElementById("status").innerText = "Online";
        } else {
            startNewSession();
        }
    } catch(err){
        console.error(err);
        startNewSession();
    }
}

// -------------------- START SESSION --------------------
async function startNewSession(){
    try{
        const res = await fetch(`${API_BASE}/sessions/start`, {
            method:"POST",
            headers: {
                "Content-Type":"application/json",
                "Authorization":"Bearer " + localStorage.getItem("token")
            },
            body: JSON.stringify({
                email: userName,
                device: userDevice,
                location: "Head Office"
            })
        });
        const data = await res.json();
        sessionId = data.sessionId;
        loginTime = new Date(data.loginTime);
        document.getElementById("loginTime").innerText = new Date(loginTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        startTimer(0);
        document.getElementById("status").innerText = "Online";
    } catch(err){
        console.error(err);
        alert("Failed to start session.");
    }
}

// -------------------- END SHIFT --------------------
async function endShift(){
    if(!sessionId) return alert("No active session found.");
    clearInterval(timerInterval);

    try{
        const res = await fetch(`${API_BASE}/sessions/end`, {
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "Authorization":"Bearer "+localStorage.getItem("token")
            },
            body: JSON.stringify({ sessionId })
        });
        const data = await res.json();

        // populate summary
        document.getElementById("summaryLogoutTime").innerText = new Date(data.logoutTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        document.getElementById("summaryTotalDuration").innerText = data.totalDuration;

        document.getElementById("trackingView").style.display = "none";
        document.getElementById("summaryView").style.display = "block";
    } catch(err){
        console.error(err);
        alert("Failed to end shift.");
    }
}

// -------------------- LOGOUT --------------------
function logout(){
    localStorage.clear();
    window.location.href = "login.html";
}

// -------------------- CONFIRM & EXIT --------------------
function confirmExit(){
    window.location.href = "settings.html";
}

// -------------------- INIT --------------------
fetchCurrentSession();
</script>

</body>
</html>
